#cloud-config

write_files:
  - path: /etc/systemd/system/docker.service.d/50-additional_docker_options.conf
    content: |
        [Service]
        Environment=DOCKER_OPT_BIP="--bip=172.17.42.1/24"

coreos:
  update:
    reboot-strategy: off
  etcd:
      name: bootstrap
      addr: $public_ipv4:4001
      peer-addr: $public_ipv4:7001 
#  fleet:
#      public-ip: $public_ipv4
  units:
    - name: etcd.service
      command: start 
#    - name: fleet.service
#      command: start
    - name: 00-eth1.network
      runtime: true
      content: |
      [Match]
      Name=eth1

      [Network]
      Address:172.17.8.2/24
    - name: docker-tcp.socket
      command: start
      enable: true
      content: |
        [Unit]
        Description=Docker Socket for the API

        [Socket]
        ListenStream=4243
        Service=docker.service
        BindIPv6Only=both

        [Install]
        WantedBy=sockets.target
    - name: docker-registry.service
      command: start
      runtime: no
      enable: true
      content: |
        [Unit]
        Description=Docker Registry Service
        After=docker.service
        Requires=docker.service

        [Service]
        ExecStartPre=/var/lib/docker-registry-service/docker-registry-service build
        ExecStart=/var/lib/docker-registry-service/docker-registry-service run
        TimeoutSec=600
        Restart=always
        RestartSec=10

        [Install]
        WantedBy=multi-user.target
#    - name: docker-registry-announce.service
#      command: start
#      runtime: no
#      enable: true
#      content: |
#        [Unit]
#        Description=Docker Registry Announce
#        BindsTo=docker-registry-service.service
#
#        [Service]
#        ExecStart=/bin/sh -c "while true; do etcdctl set /inaetics/docker-registry-service/%m $public_ipv4:5000 --ttl 60; sleep 45; done"
#        ExecStopPost=/usr/bin/etcdctl rm /inaetics/docker-registry-service/%m
#
#        [Install]
#       # WantedBy=multi-user.target
